# 6 курс. Курсовая работа “Бот в Telegram”

В данной курсовой работе вам предстоит разработать бота для Telegram, который умел бы принимать от пользователя сообщения в формате `01.01.2022 20:00 Сделать домашнюю работу` и присылать пользователю сообщение в 20:00 1 января 2022 года с текстом “Сделать домашнюю работу”.

## Перед началом

Telegram — один из самых удобных и многофункциональных мессенджеров на сегодняшний день. Изначально Telegram предназначался для безопасного общения, в условиях высокого уровня шифрования данных. Но со временем приложение обросло функционалом до такой степени, что в нем стало возможным создавать полноценные обучающие каналы, сервисы по поиску музыки, автоматические переводчики и оперативные службы СМИ.

- Как установить телеграм на ваш персональный компьютер
1. Запустите интернет-браузер (рекомендуем использовать Google Chrome).
2. В адресной строке введите название сайта [https://telegram.org](https://telegram.org/). Сайт безопасен - мы проверили!
3. На главной странице вы увидите все поддерживаемые устройства (включая Windows и iOS). Скачайте установочный файл в соответствии с установленной на компьютере операционной системой.
4. Запустите скачанный файл, выберите язык установки и нажмите «Далее» (возможно Windows потребует разрешения запустить файл).
5. Выберите место, куда устанавливать программу. Рекомендуем не менять стандартный путь установки.
6. Нажмите «Далее» и дождитесь завершения установки.
7. Если вы разобрались, как установить телеграмм на компьютер на русском языке бесплатно, то можно переходить к следующему этапу.

Одной установки приложения будет недостаточно, чтобы полноценно пользоваться мессенджером. Необходимо также пройти простую регистрацию нового аккаунта. Это единственный способ получить SMS с подтверждением, так как каждый телеграм-аккаунт привязывается к реальному номеру мобильного телефона.

- Как зарегистрироваться в Telegram

    Если вы еще не пользуетесь Telegram, то ваш номер не привязан. Для этого

1. Запустите установленную программу.
2. Выберите «Вход по номеру телефона».
3. Введите номер телефона.
4. Введите полученный смс-код подтверждения.

## Задача 1. Сборка телеграм-бота

## 1.1 Зарегистрировать своего телеграм бота

Добавить к себе в телеграм бота [https://t.me/BotFather](https://t.me/BotFather), активировать его командой `/start` и следовать инструкциями. Главная цель этой задачи — получить токен вида `6290793636:AAGIqfVDV9My8UfMQGfvG5arXo8ZAaY6Bhs`, который будет использоваться вами в дальнейшем при разработке своего бота для доступа к Bot API Telegram.

## 1.2 Клонирование репозитория

Цель задачи — получить у себя на компьютере шаблон приложения с настроенным для работы Spring Boot’ом.

Здесь вам необходимо форкнуть репозиторий и клонировать его к себе в директорию с Java проектами. Взять репозиторий можно и из архива, представленного ниже.

[telegram-bot.zip](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/a66d2a91-e4bf-4c9f-9ca4-f3668766a2ab/telegram-bot.zip)

## 1.3 Сконфигурировать склонированное приложение

Цель задачи — получить работающий проект на вашем компьютере, который можно запустить в IDEA.

Необходимо создать базу данных и пользователя, которая будет использоваться вашим приложением. Используя [application.properties](http://application.properties) настроить подключение к базе данных и передать токен, полученный в 1ой задаче.

## 1.4 Научиться реагировать на команду /start и выводить приветственное сообщение

Теперь, когда у вас есть запускающийся проект, самое время в классе `TelegramBotUpdatesListener` в методе `public int process(List<Update> updates)` научиться обрабатывать команду `/start`, отправляемую пользователем нашему боту в Telegram. **Для этого необходимо проитерироваться по всем апдейтам, которые наш метод принимает в качестве аргумента и, в случае, если мы получили сообщение `/start` — вывести приветственное сообщение. Текст сообщения — на ваш вкус.

- Подсказка 1

    Текст сообщения можно найти в `update.message().text()`

- Подсказка 2

    Чтобы понять идентификатор чата, в который нужно отправить сообщение, нужно вызвать `update.message().chat().id()`


## Задача 2

## 2.1 Создать использую liquibase таблицу notification_task

Цель задачи —  получить после старта приложения таблицу нужной нам структуры в БД.

Теперь настало самое время понять, как мы будем хранить наши таски в базе данных и спроектировать для этого схему базы данных. Предположу, что нам потребуется иметь первичный ключ в таблице, идентификатор чата, в который нужно отправить уведомление, текст уведомления и дату+время, когда требуется отправить уведомление. Возможно, вы захотите хранить какие-то дополнительные данные. Примерно такой структуры нужно создать таблицу использую liquibase.

## 2.2 Создать сущность notification task

Цель задачи — получить класс с аннотацией `@Entity`, который будет повторять структуру нашей таблицы в БД и будет пригоден для использования в коде нашего приложения.

После того, как мы создали таблицу, необходимо создать сущность, с которой мы будем работать в коде нашего приложения.

- Подсказка 1

    Для представления даты и времени удобно использовать класс `LocalDateTime`


## 2.3 Создать репозиторий для сущности notification task

Цель задачи — получить интерфейс, с помощью которого можно сохранять и доставать из БД наши сущности.

Следующий шаг — создать расширение `JpaRepository<T, ID>`, который был бы пригоден для работу с сущностью, созданной в предыдущем шаге.

## 2.4 Научиться парсить сообщения с создаваемым напоминанием и сохранять их в БД

Цель задачи — получить записи в базе данных, соответствующие отправленным сообщениям.


Наконец-то мы добрались до самого важно задания — мы должны научить обрабатывать получаемый от пользователя сообщения вида `01.01.2022 20:00 Сделать домашнюю работу` , вычленять из него дату+время (01.01.2022 20:00) и текст напоминания (Сделать домашнюю работу), создавать на основе этих данных сущность и сохранять её в БД.

Для распознавания в строке подстроки с датой и подстроки с сообщением нам потребуются регулярные выражения, подробнее о них в методичке.

- Подсказка 1

    Паттерн, которая поможет распознать дату и текст напоминания имеет вид `([0-9\.\:\s]{16})(\s)([\W+]+)`


После того, как мы отделили дату и текст напоминания во входящем сообщении, нам необходимо сконструировать сущность.

- Подсказка 2

    Для того, чтобы из строки вида `01.01.2022 20:00` сконструировать объект класса `LocalDateTime` необходимо использовать кастомный паттерн и вызывать метод вида `LocalDateTime.parse("01.01.2022 20:00", DateTimeFormatter.ofPattern("dd.MM.yyyy HH:mm"))`


Имея сконструированную сущность необходимо сохранить её использую методы репозитория.

## 2.5 Научиться по шедулеру раз в минуту выбирать записи из БД, для которых должны быть отправлены нотификации

Цель задачи — иметь коллекцию записей из БД у которых дата и время отправки нотификации сейчас.

Шедулинг — механизм выполнения некоторых методов по расписанию, подробнее об этом в методичке.

Необходимо выполнять раз в минуту метод, который ищет записи в БД с датой выполнения — текущая минута.

- Подсказка 1

    cron expression для запуска метода каждую секунду —  `0 0/1 * * * *`

- Подсказка 2

    Так как шедулер может запускаться с лагом в несколько миллисекунд, то для поиска лучше не просто брать текущее время методом `LocalDateTime.now()` , но “обрезать” его до минут, чтобы получилось время с 00 секунд. Это делается методом `truncatedTo` так `LocalDateTime.now().truncatedTo(ChronoUnit.MINUTES)`.


Помимо этого, нужно написать в репозитории метод, который ищет записи, у которых время совпадает с текущим.

## 2.6 Научиться для выбранных записей рассылать уведомления

Для полученной коллекции записей из прошлой задачи необходимо рассылать уведомления в нужные чаты.